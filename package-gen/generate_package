#!/bin/bash

# Package information
PACKAGE_NAME="backup-restore-tool"
VERSION="1.0"
BUILD_DIR="../${PACKAGE_NAME}_${VERSION}"

# Cleaning up the old build
echo "üßπ Cleaning up the old directory $BUILD_DIR..."
rm -rf "$BUILD_DIR"

# Creating a clean copy of the existing structure
echo "üì¶ Creating the package directory structure..."
mkdir -p "$BUILD_DIR"

# Recursively copying everything except unnecessary files (README, script, etc.)
cp -r ../DEBIAN "$BUILD_DIR/"
cp -r ../usr "$BUILD_DIR/"
cp -r ../etc "$BUILD_DIR/"

# Setting necessary permissions
echo "üîß Setting permissions..."
chmod 755 "$BUILD_DIR/DEBIAN"
chmod 755 "$BUILD_DIR/usr/local/bin/ubuntu_backup_restore"
chmod 644 "$BUILD_DIR/etc/backup-restore-tool/nas_config.conf"
chmod 644 "$BUILD_DIR/etc/backup-restore-tool/nas_config_example.conf"

# Generating launcher icon
echo "üñºÔ∏è Generating the launcher icon..."
mkdir -p "$BUILD_DIR/usr/share/icons/hicolor/256x256/apps"
cp ../usr/share/icons/hicolor/256x256/apps/backup-restore.png "$BUILD_DIR/usr/share/icons/hicolor/256x256/apps/"

# Creating application launcher
echo "üöÄ Creating the application launcher..."
mkdir -p "$BUILD_DIR/usr/share/applications"
cp ../usr/share/applications/backup-restore.desktop "$BUILD_DIR/usr/share/applications/"

# Building the package
echo "üõ†Ô∏è  Building the .deb package..."
dpkg-deb --build "$BUILD_DIR"

# Renaming the final package
mv "${BUILD_DIR}.deb" "../${PACKAGE_NAME}_${VERSION}_all.deb"

echo "‚úÖ Package successfully generated: ../${PACKAGE_NAME}_${VERSION}_all.deb"